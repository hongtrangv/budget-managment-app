<!-- src/pages/management.html -->
<style>
    /* --- Tree Menu Styling --- */
    .tree-menu ul {
        list-style-type: none;
        padding-left: 25px;
        border-left: 1px dashed #ccc;
    }

    .tree-menu li {
        position: relative;
        padding: 4px 0;
    }

    .tree-menu li::before {
        content: '';
        position: absolute;
        top: 15px;
        left: -25px;
        width: 20px;
        height: 1px;
        background-color: #ccc;
    }

    /* Nút mở rộng/thu gọn (+/-) */
    .tree-menu .toggle {
        cursor: pointer;
        display: inline-block;
        font-weight: bold;
        margin-right: 8px;
        font-family: monospace;
        user-select: none; /* Ngăn chặn việc chọn văn bản khi nhấp đúp */
    }

    /* Ẩn các nhánh con theo mặc định */
    .tree-menu .nested {
        display: none;
    }

    /* Hiển thị các nhánh con khi mục cha có lớp 'active' */
    .tree-menu .active {
        display: block;
    }

    /* Thay đổi biểu tượng khi mở rộng */
    .tree-menu .toggle.expanded::before {
        content: '- ';
    }

    .tree-menu .toggle:not(.expanded)::before {
        content: '+ ';
    }

    .tree-menu .leaf-node {
        padding-left: 28px; /* Căn chỉnh các mục con không có nút toggle */
    }
</style>

<h1 class="text-2xl font-bold mb-4">Quản lý Chi tiêu theo Thời gian</h1>

<div id="management-tree" class="tree-menu">
    <!-- Cây menu sẽ được tạo tự động bởi JavaScript -->
    <p>Đang tải dữ liệu...</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const treeContainer = document.getElementById('management-tree');

    // Hàm để gọi API và lấy dữ liệu cây
    async function fetchManagementTree() {
        try {
            const response = await fetch('/api/management/tree');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            renderTree(data);
        } catch (error) {
            treeContainer.innerHTML = `<p class="text-red-500">Lỗi khi tải dữ liệu: ${error.message}</p>`;
            console.error('Error fetching management tree:', error);
        }
    }

    // Hàm để hiển thị dữ liệu lên cây menu
    function renderTree(data) {
        if (!data || Object.keys(data).length === 0) {
            treeContainer.innerHTML = '<p>Không có dữ liệu chi tiêu để hiển thị.</p>';
            return;
        }

        let treeHtml = '<ul>';

        // Lặp qua các năm (sắp xếp giảm dần)
        const sortedYears = Object.keys(data).sort((a, b) => b - a);
        for (const year of sortedYears) {
            treeHtml += '<li>';
            treeHtml += `<span class="toggle">${year}</span>`;
            treeHtml += '<ul class="nested">';

            // Lặp qua các tháng trong năm (sắp xếp giảm dần)
            const sortedMonths = Object.keys(data[year]).sort((a, b) => b - a);
            for (const month of sortedMonths) {
                treeHtml += '<li>';
                treeHtml += `<span class="toggle">Tháng ${month}</span>`;
                treeHtml += '<ul class="nested">';

                // Lặp qua các mục chi tiêu trong tháng
                if (data[year][month].length > 0) {
                    data[year][month].forEach(item => {
                        // Định dạng lại ngày và số tiền cho dễ đọc
                        const formattedDate = new Date(item.date).toLocaleDateString('vi-VN');
                        const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.amount);
                        treeHtml += `<li class="leaf-node">${item.name}: ${formattedAmount} - <em>(${formattedDate})</em></li>`;
                    });
                } else {
                    treeHtml += '<li class="leaf-node"><em>Không có chi tiêu trong tháng này.</em></li>';
                }

                treeHtml += '</ul></li>'; // Đóng thẻ <ul> và <li> của tháng
            }
            treeHtml += '</ul></li>'; // Đóng thẻ <ul> và <li> của năm
        }
        treeHtml += '</ul>';
        treeContainer.innerHTML = treeHtml;
        addToggleEventListeners();
    }

    // Hàm để thêm sự kiện click cho các nút (+/-)
    function addToggleEventListeners() {
        const toggles = document.querySelectorAll('.tree-menu .toggle');
        toggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                this.classList.toggle('expanded');
                const nestedList = this.nextElementSibling;
                if (nestedList && nestedList.classList.contains('nested')) {
                    nestedList.classList.toggle('active');
                }
            });
        });
    }

    // Bắt đầu quá trình
    fetchManagementTree();
});
</script>
